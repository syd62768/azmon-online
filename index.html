<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شبیه‌ساز نهایی آزمون استخدامی</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --font-family: 'Vazirmatn', sans-serif;
    --bg-main: #f0f2f5;
    --bg-card: #ffffff;
    --primary-color: #00796b;
    --primary-light: #e0f2f1;
    --secondary-color: #5c6bc0;
    --text-color: #263238;
    --border-color: #cfd8dc;
    --success-color: #388e3c;
    --success-light: #e8f5e9;
    --danger-color: #d32f2f;
    --danger-light: #ffebee;
    --warning-color: #f9a825;
    --warning-light: #fffde7;
    --shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    --sanjesh-blue: #1a237e;
    --sanjesh-header: #e8eaf6;
  }

  /* General Body Styles */
  body {
    font-family: var(--font-family);
    background-color: var(--bg-main);
    color: var(--text-color);
    margin: 0;
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 1.5rem 1rem 10rem; 
  }
  
  /* --- Login Section --- */
  #login-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
  }
  .login-card {
    background: var(--bg-card);
    padding: 2.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    text-align: center;
    width: 100%;
    max-width: 450px;
    box-sizing: border-box;
    border-top: 5px solid var(--primary-color);
  }
  .login-card h1 { color: var(--primary-color); margin-top: 0; }
  .login-card p { margin-bottom: 2rem; color: #546e7a; }
  .login-card input {
    font-family: var(--font-family);
    width: 100%;
    padding: 0.8rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    margin-bottom: 1rem;
    text-align: center;
  }
  .login-card .btn { width: 100%; }
  #error-message { color: var(--danger-color); margin-top: 1rem; min-height: 20px; font-weight: 500; }
  
  /* --- Exam Section --- */
  #exam-section { display: none; }

  header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 2.5rem 1.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    text-align: center;
    margin-bottom: 2rem;
  }
  header h1 { margin: 0; font-size: 2rem; font-weight: 700; }
  header p { margin: 0.5rem 0 0; opacity: 0.9; font-size: 1rem; }

  .exam-toolbar {
    position: sticky;
    top: 1rem;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    z-index: 10;
    border-radius: 12px;
    padding: 0.75rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
  }

  .btn {
    font-family: var(--font-family);
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn svg { width: 18px; height: 18px; }

  .btn-submit { background-color: var(--primary-color); color: white; }
  .btn-submit:hover { background-color: #004d40; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 121, 107, 0.3); }
  .btn-reset { background-color: #78909c; color: white; }
  .btn-reset:hover { background-color: #546e7a; transform: translateY(-2px); }
  .btn-mark { background-color: var(--warning-color); color: white; }
  .btn-mark:hover { background-color: #f59300; }
  .btn-mark.marked { background-color: #c78400; }
  
  .timer {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--secondary-color);
    background-color: var(--sanjesh-header);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    min-width: 100px;
    text-align: center;
  }
  .toolbar-group { display: flex; gap: 0.5rem; }

  .section-title, .topic-title { margin: 3rem 0 1.5rem; }
  .section-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); text-align: center; position: relative; padding-bottom: 1rem; }
  .section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 4px; background-color: var(--secondary-color); border-radius: 2px; }
  .topic-title { font-size: 1.4rem; font-weight: 600; color: var(--text-color); padding-right: 1rem; border-right: 5px solid var(--secondary-color); text-align: right; }
  
  .question-card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    box-shadow: var(--shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    scroll-margin-top: 6rem; /* Offset for sticky toolbar */
  }
  .question-card.marked-for-review { border-left: 5px solid var(--warning-color); }
  .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
  .q-text { font-weight: 500; font-size: 1.1rem; line-height: 1.8; margin: 0; }
  .q-number { font-weight: 700; margin-left: 8px; color: var(--primary-color); }
  .choices { display: flex; flex-direction: column; gap: 0.75rem; }
  .choice { display: flex; align-items: center; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s ease; user-select: none; }
  .choice.selected, .choice:hover { border-color: var(--secondary-color); background-color: var(--sanjesh-header); }
  .choice input[type="radio"] { margin-left: 0.8rem; flex-shrink: 0; pointer-events: none; }
  .choice.correct { border-color: var(--success-color) !important; background-color: var(--success-light) !important; color: var(--success-color); font-weight: 600; }
  .choice.incorrect { border-color: var(--danger-color) !important; background-color: var(--danger-light) !important; color: var(--danger-color); font-weight: 600; }
  
  /* --- Modals --- */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
  .modal-overlay.visible { opacity: 1; visibility: visible; }
  .modal-content { background: var(--bg-main); border-radius: 16px; padding: 1rem; width: 95%; max-width: 850px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(0.9); transition: transform 0.3s ease; }
  .modal-overlay.visible .modal-content { transform: scale(1); }
  .modal-header { background-color: var(--sanjesh-header); padding: 1.2rem; border-radius: 12px 12px 0 0; border-bottom: 2px solid var(--sanjesh-blue); text-align: center; }
  .modal-header h2 { color: var(--sanjesh-blue); margin: 0; font-size: 1.5rem; font-weight: 700; }
  .modal-header p { font-size: 0.9rem; color: #3f51b5; margin: 0.5rem 0 0; }
  
  /* --- Report Card --- */
  .report-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; font-size: 0.9rem; }
  .report-table th, .report-table td { border: 1px solid #b0bec5; padding: 0.75rem; text-align: center; }
  .report-table thead { background-color: var(--sanjesh-blue); color: white; font-weight: 600; }
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1.5rem 0; text-align: center; }
  .summary-item { background: var(--bg-card); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .summary-item .label { font-size: 0.9rem; color: #546e7a; margin-bottom: 0.5rem; }
  .summary-item .value { font-size: 1.5rem; font-weight: 700; color: var(--sanjesh-blue); }
  .probability-box { margin: 1.5rem 0; padding: 1.5rem; background: var(--bg-card); border-radius: 12px; border: 2px solid var(--sanjesh-header); }
  .probability-box .title { font-size: 1.2rem; font-weight: 700; color: var(--sanjesh-blue); text-align: center; }
  .probability-box .text { font-size: 1rem; line-height: 1.8; text-align: justify; }
  .report-actions { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }


  /* --- Question Navigation Panel --- */
  .question-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    z-index: 20;
    padding: 0.5rem;
    overflow-x: auto;
    scrollbar-width: thin;
  }
  .question-nav-inner { display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 0.5rem; min-width: max-content; }
  .nav-btn { width: 38px; height: 38px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-card); color: var(--text-color); font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
  .nav-btn:hover { transform: translateY(-2px); border-color: var(--secondary-color); }
  .nav-btn.answered { background-color: var(--success-color); color: white; border-color: var(--success-color); }
  .nav-btn.marked { background-color: var(--warning-color); color: white; border-color: var(--warning-color); }

  .loader { text-align: center; padding: 4rem; font-size: 1.2rem; color: var(--primary-color); }
</style>
</head>
<body>

<div class="container">
  
  <section id="login-section">
    <div class="login-card">
      <h1>شبیه‌ساز آزمون استخدامی</h1>
      <p>برای شروع آزمون، لطفاً نام خود را وارد کنید.</p>
      <form id="login-form">
        <input type="text" id="name-input" placeholder="نام و نام خانوادگی" autocomplete="off">
        <button type="submit" class="btn btn-submit">🚀 شروع آزمون</button>
      </form>
      <div id="error-message"></div>
    </div>
  </section>

  <section id="exam-section">
    <header>
      <h1 id="header-title">شبیه‌ساز آزمون استخدامی</h1>
      <p id="header-subtitle">موفق باشید!</p>
    </header>
    <main>
      <div class="exam-toolbar" id="exam-toolbar">
        <div class="toolbar-group">
            <button onclick="confirmSubmission()" class="btn btn-submit">✅ اتمام آزمون</button>
            <button onclick="confirmReset()" class="btn btn-reset">🔄 آزمون مجدد</button>
        </div>
        <div class="timer" id="timer">--:--:--</div>
        <div class="toolbar-group">
            <button id="fullscreen-btn" onclick="toggleFullScreen()" class="btn" style="background-color: #607d8b; color: white;">
              <svg id="fullscreen-enter-icon" xmlns="http://www.w.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 2h-2v3h-3v2h5v-5zm-3-4V5h-3v2h3v3h2V5z"/></svg>
              <svg id="fullscreen-exit-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
            </button>
        </div>
      </div>
      
      <div class="exam-toolbar" id="review-toolbar" style="display: none;">
        <span>مرور پاسخ‌ها (آزمون به پایان رسیده است)</span>
        <button onclick="exitReviewMode()" class="btn btn-submit">بازگشت به کارنامه</button>
      </div>

      <div id="exam-container">
        <div class="loader">در حال بارگذاری سوالات...</div>
      </div>
    </main>
  </section>
</div>

<!-- Question Navigation Panel -->
<div class="question-nav" id="question-nav" style="display: none;">
  <div class="question-nav-inner" id="question-nav-inner"></div>
</div>

<!-- Report Card Modal -->
<div class="modal-overlay" id="reportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>کارنامه اولیه آزمون</h2>
      <p id="report-user-name"></p>
    </div>
    <div id="reportBody">
      <div class="summary-grid">
          <div class="summary-item"><div class="label">درصد کل شما</div><div class="value" id="finalScore">--%</div></div>
          <div class="summary-item"><div class="label">رتبه شما</div><div class="value" id="userRank">--</div></div>
          <div class="summary-item"><div class="label">میانگین جامعه آماری</div><div class="value" id="averageScore">--%</div></div>
      </div>
      <table class="report-table">
        <thead><tr><th>نام درس</th><th>صحیح</th><th>غلط</th><th>نزده</th><th>درصد</th></tr></thead>
        <tbody id="reportTableBody"></tbody>
      </table>
      <div class="probability-box">
          <div class="title">تحلیل وضعیت قبولی</div><div class="text" id="finalProbability"></div>
      </div>
      <p style="font-size:0.8rem; color: #6b7280; margin-top: 1rem; text-align:center;">
        توجه: رتبه و تحلیل بر اساس شبیه‌سازی ۱۲۰,۰۰۰ شرکت‌کننده و قوانین حد نصاب آزمون‌های واقعی ارائه شده است.
      </p>
    </div>
    <div class="report-actions">
        <button onclick="enterReviewMode()" class="btn btn-submit">🔍 مرور پاسخ‌ها</button>
        <button onclick="closeModal('reportModal')" class="btn btn-reset">بستن</button>
    </div>
  </div>
</div>

<!-- Confirmation Modals -->
<div class="modal-overlay" id="confirmSubmitModal">
    <div class="modal-content" style="max-width: 450px; text-align: center;">
      <div class="modal-header"><h2>اتمام آزمون</h2></div>
      <div style="padding: 1.5rem;">
        <p>آیا از اتمام آزمون و صدور کارنامه اطمینان دارید؟</p>
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
          <button onclick="submitExam()" class="btn btn-submit">بله، کارنامه صادر شود</button>
          <button onclick="closeModal('confirmSubmitModal')" class="btn btn-reset">خیر</button>
        </div>
      </div>
    </div>
</div>
<div class="modal-overlay" id="confirmResetModal">
    <div class="modal-content" style="max-width: 450px; text-align: center;">
      <div class="modal-header"><h2>آزمون مجدد</h2></div>
      <div style="padding: 1.5rem;">
        <p>آیا می‌خواهید آزمون را از ابتدا شروع کنید؟ تمام پاسخ‌های فعلی شما پاک خواهد شد.</p>
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
          <button onclick="resetExam()" class="btn btn-submit">بله، شروع مجدد</button>
          <button onclick="closeModal('confirmResetModal')" class="btn btn-reset">خیر</button>
        </div>
      </div>
    </div>
</div>
<div class="modal-overlay" id="confirmResumeModal">
    <div class="modal-content" style="max-width: 450px; text-align: center;">
      <div class="modal-header"><h2>ادامه آزمون قبلی</h2></div>
      <div style="padding: 1.5rem;">
        <p>ما یک آزمون نیمه‌کاره با این نام پیدا کردیم. آیا می‌خواهید آن را ادامه دهید؟</p>
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;">
          <button id="resume-yes-btn" class="btn btn-submit">بله، ادامه می‌دهم</button>
          <button id="resume-no-btn" class="btn btn-reset">خیر، آزمون جدید</button>
        </div>
      </div>
    </div>
</div>


<script>
let questions = [];
let examStructure = {};
let timerInterval = null;
let saveInterval = null;
let currentUser = null;
const EXAM_DURATION_MINUTES = 125; 

let examState = {
    userAnswers: {},
    markedQuestions: {},
    timeLeft: EXAM_DURATION_MINUTES * 60,
};

const dom = {
    loginSection: document.getElementById('login-section'),
    examSection: document.getElementById('exam-section'),
    loginForm: document.getElementById('login-form'),
    nameInput: document.getElementById('name-input'),
    errorMessage: document.getElementById('error-message'),
    examContainer: document.getElementById('exam-container'),
    timer: document.getElementById('timer'),
    examToolbar: document.getElementById('exam-toolbar'),
    reviewToolbar: document.getElementById('review-toolbar'),
    fullscreenEnterIcon: document.getElementById('fullscreen-enter-icon'),
    fullscreenExitIcon: document.getElementById('fullscreen-exit-icon'),
    questionNav: document.getElementById('question-nav'),
    questionNavInner: document.getElementById('question-nav-inner'),
    reportModal: document.getElementById('reportModal'),
    confirmSubmitModal: document.getElementById('confirmSubmitModal'),
    confirmResetModal: document.getElementById('confirmResetModal'),
    confirmResumeModal: document.getElementById('confirmResumeModal'),
    headerTitle: document.getElementById('header-title'),
    reportUserName: document.getElementById('report-user-name'),
    finalScore: document.getElementById('finalScore'),
    userRank: document.getElementById('userRank'),
    averageScore: document.getElementById('averageScore'),
    reportTableBody: document.getElementById('reportTableBody'),
    finalProbability: document.getElementById('finalProbability')
};

// --- Initialization & Event Listeners ---
document.addEventListener('DOMContentLoaded', init);
document.addEventListener('fullscreenchange', updateFullscreenIcon);

async function init() {
  try {
    const response = await fetch('./soal.json');
    if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
    questions = await response.json();
    
    questions.forEach(q => {
        if (!examStructure[q.section]) examStructure[q.section] = {};
        if (!examStructure[q.section][q.topic]) examStructure[q.section][q.topic] = 0;
        examStructure[q.section][q.topic]++;
    });
  } catch (error) {
    dom.loginSection.querySelector('.login-card').innerHTML = `<div class="loader" style="color: var(--danger-color);">خطا در بارگذاری سوالات.<br><small>${error.message}</small></div>`;
  }
}

dom.loginForm.addEventListener('submit', e => {
    e.preventDefault();
    handleLogin();
});


// --- Exam Flow ---
function handleLogin() {
    const name = dom.nameInput.value.trim();
    if (!name) {
        dom.errorMessage.textContent = 'لطفاً نام خود را وارد کنید.';
        return;
    }
    
    const finishedExam = localStorage.getItem(`exam_result_${name}`);
    if (finishedExam) {
        dom.errorMessage.textContent = 'این نام قبلاً در آزمون شرکت کرده و کارنامه دریافت کرده است.';
        return;
    }
    
    currentUser = name;
    const savedState = loadState();
    
    if (savedState) {
        dom.confirmResumeModal.classList.add('visible');
        document.getElementById('resume-yes-btn').onclick = () => {
            closeModal('confirmResumeModal');
            examState = savedState;
            startExam(true);
        };
        document.getElementById('resume-no-btn').onclick = () => {
            closeModal('confirmResumeModal');
            clearState(); 
            startExam(false);
        };
    } else {
        startExam(false);
    }
}

function startExam(isResuming = false) {
    dom.headerTitle.textContent = `آزمون‌دهنده: ${currentUser}`;
    dom.loginSection.style.display = 'none';
    dom.examSection.style.display = 'block';
    dom.questionNav.style.display = 'block';

    renderExam();
    
    if (isResuming) {
        applySavedState();
    }
    
    startTimer(examState.timeLeft);
    saveInterval = setInterval(saveState, 5000);
}

// --- Rendering ---
function renderExam() {
    dom.examContainer.innerHTML = '';
    let questionCounter = 1;
    const fragment = document.createDocumentFragment();
    
    Object.keys(examStructure).forEach(section => {
        const sectionTitle = document.createElement('h2');
        sectionTitle.className = 'section-title';
        sectionTitle.textContent = section;
        fragment.appendChild(sectionTitle);

        Object.keys(examStructure[section]).forEach(topic => {
            const topicTitle = document.createElement('h3');
            topicTitle.className = 'topic-title';
            topicTitle.textContent = topic;
            fragment.appendChild(topicTitle);
            
            questions.filter(q => q.topic === topic).forEach(q => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `q-card-${q.id}`;
                card.innerHTML = `
                    <div class="q-header">
                        <p class="q-text"><span class="q-number">${questionCounter++}.</span>${q.question}</p>
                        <button class="btn btn-mark" data-qid="${q.id}" onclick="toggleMark(this)">علامت‌گذاری</button>
                    </div>
                    <div class="choices">
                        ${q.options.map((choice, index) => `
                            <label class="choice" for="q${q.id}_${index}" data-qid="${q.id}" data-value="${index}">
                                <input type="radio" name="q${q.id}" id="q${q.id}_${index}" value="${index}">
                                <span>${choice}</span>
                            </label>
                        `).join('')}
                    </div>`;
                fragment.appendChild(card);
            });
        });
    });
    dom.examContainer.appendChild(fragment);
    renderNav();
    dom.examContainer.addEventListener('click', handleChoiceClick);
}

function renderNav() {
    dom.questionNavInner.innerHTML = '';
    questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.textContent = index + 1;
        btn.id = `nav-btn-${q.id}`;
        btn.onclick = () => document.getElementById(`q-card-${q.id}`).scrollIntoView({ behavior: 'smooth' });
        dom.questionNavInner.appendChild(btn);
    });
    updateNav();
}

function updateNav() {
    questions.forEach(q => {
        const navBtn = document.getElementById(`nav-btn-${q.id}`);
        if (!navBtn) return;
        navBtn.classList.remove('answered', 'marked');
        if (examState.markedQuestions[q.id]) {
            navBtn.classList.add('marked');
        } else if (examState.userAnswers[q.id] !== undefined && examState.userAnswers[q.id] !== null) {
            navBtn.classList.add('answered');
        }
    });
}

// --- User Actions & Event Handlers ---
function handleChoiceClick(e) {
    const label = e.target.closest('.choice');
    if (!label) return;

    // جلوگیری از رفتار پیش‌فرض مرورگر برای کنترل کامل انتخاب
    e.preventDefault();

    const radio = label.querySelector('input[type="radio"]');
    const qid = label.dataset.qid;
    const value = parseInt(label.dataset.value, 10);

    const isAlreadySelected = radio.checked;

    // ابتدا تمام انتخاب‌های این سوال را پاک می‌کنیم
    document.querySelectorAll(`input[name="q${qid}"]`).forEach(r => {
        r.checked = false;
        r.closest('.choice').classList.remove('selected');
    });

    // اگر گزینه‌ی کلیک‌شده، گزینه‌ی انتخاب‌شده‌ی قبلی نبود، آن را انتخاب می‌کنیم
    if (!isAlreadySelected) {
        radio.checked = true;
        label.classList.add('selected');
        examState.userAnswers[qid] = value;
    } else {
        // اگر گزینه‌ی انتخاب‌شده‌ی قبلی بود، آن را از انتخاب خارج می‌کنیم
        examState.userAnswers[qid] = null;
    }

    updateNav();
}


function toggleMark(button) {
    const qid = button.dataset.qid;
    const card = document.getElementById(`q-card-${qid}`);
    examState.markedQuestions[qid] = !examState.markedQuestions[qid];
    
    if (examState.markedQuestions[qid]) {
        button.classList.add('marked');
        button.textContent = 'حذف علامت';
        card.classList.add('marked-for-review');
    } else {
        delete examState.markedQuestions[qid];
        button.classList.remove('marked');
        button.textContent = 'علامت‌گذاری';
        card.classList.remove('marked-for-review');
    }
    updateNav();
}

// --- Timer, State, and Fullscreen ---
function startTimer(duration) {
    let timer = duration;
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        examState.timeLeft = timer;
        const hours = String(Math.floor(timer / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((timer % 3600) / 60)).padStart(2, '0');
        const seconds = String(timer % 60).padStart(2, '0');
        dom.timer.textContent = `${hours}:${minutes}:${seconds}`;
        if (--timer < 0) {
            dom.timer.textContent = "پایان یافت";
            submitExam();
        }
    }, 1000);
}

function saveState() {
    if (!currentUser) return;
    localStorage.setItem(`exam_progress_${currentUser}`, JSON.stringify(examState));
}
function loadState() {
    if (!currentUser) return null;
    return JSON.parse(localStorage.getItem(`exam_progress_${currentUser}`));
}
function clearState() {
    if (!currentUser) return;
    localStorage.removeItem(`exam_progress_${currentUser}`);
    examState = { userAnswers: {}, markedQuestions: {}, timeLeft: EXAM_DURATION_MINUTES * 60 };
}

function applySavedState() {
    Object.keys(examState.userAnswers).forEach(qid => {
        const value = examState.userAnswers[qid];
        if (value !== null) {
            const radio = document.querySelector(`input[name="q${qid}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
                radio.closest('.choice').classList.add('selected');
            }
        }
    });
    Object.keys(examState.markedQuestions).forEach(qid => {
        if (examState.markedQuestions[qid]) {
           const button = document.querySelector(`.btn-mark[data-qid="${qid}"]`);
           if(button) toggleMark(button);
        }
    });
    updateNav();
}

function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => console.error(err));
    } else {
        document.exitFullscreen();
    }
}
function updateFullscreenIcon() {
    const isFullscreen = !!document.fullscreenElement;
    dom.fullscreenEnterIcon.style.display = isFullscreen ? 'none' : 'block';
    dom.fullscreenExitIcon.style.display = isFullscreen ? 'block' : 'none';
}

// --- Submission & Review ---
function confirmSubmission() { dom.confirmSubmitModal.classList.add('visible'); }
function confirmReset() { dom.confirmResetModal.classList.add('visible'); }

function resetExam() {
    closeModal('confirmResetModal');
    clearState();
    window.location.reload();
}

function submitExam() {
    closeModal('confirmSubmitModal');
    if(timerInterval) clearInterval(timerInterval);
    if(saveInterval) clearInterval(saveInterval);
    
    dom.examToolbar.style.display = 'none';
    dom.examContainer.removeEventListener('click', handleChoiceClick);
    document.querySelectorAll('.question-card input, .question-card button').forEach(el => el.disabled = true);

    questions.forEach(q => {
        q.options.forEach((opt, index) => {
            const label = dom.examContainer.querySelector(`label.choice[data-qid="${q.id}"][data-value="${index}"]`);
            if (!label) return;
            label.classList.remove('correct', 'incorrect');
            if (index === q.answer) label.classList.add('correct');
            else if (index === examState.userAnswers[q.id]) label.classList.add('incorrect');
        });
    });
    
    generateAdvancedReport();
    localStorage.setItem(`exam_result_${currentUser}`, 'completed'); // Use simple flag
    localStorage.removeItem(`exam_progress_${currentUser}`);
}

function enterReviewMode() {
    closeModal('reportModal');
    dom.reviewToolbar.style.display = 'flex';
    window.scrollTo(0, 0);
}

function exitReviewMode() {
    dom.reviewToolbar.style.display = 'none';
    dom.reportModal.classList.add('visible');
}

function generateAdvancedReport() {
    const report = {};
    let totalCorrect = 0, totalIncorrect = 0;
    const uniqueTopics = [...new Set(questions.map(q => q.topic))];

    uniqueTopics.forEach(topic => {
        const topicQuestions = questions.filter(q => q.topic === topic);
        let correct = 0, incorrect = 0, unanswered = 0;
        
        topicQuestions.forEach(q => {
            const userAnswer = examState.userAnswers[q.id];
            if (userAnswer === null || userAnswer === undefined) unanswered++;
            else if (userAnswer === q.answer) correct++;
            else incorrect++;
        });
        
        const total = topicQuestions.length;
        const rawScore = (correct * 3) - incorrect;
        report[topic] = {
            correct, incorrect, unanswered,
            percentage: Math.max(0, (rawScore / (total * 3)) * 100)
        };
        totalCorrect += correct;
        totalIncorrect += incorrect;
    });
    
    const overallRaw = (totalCorrect * 3) - (totalIncorrect);
    const userOverallPercentage = Math.max(0, (overallRaw / (questions.length * 3)) * 100);

    // --- Upgraded Realistic Score Simulation Engine ---
    const totalParticipants = 119999;
    const simulatedScores = [];

    // Helper to generate a normally distributed random number
    const generateNormalRandom = (mean, stdDev) => {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        let num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        return Math.max(-25, Math.min(100, num * stdDev + mean)); // Clamped between -25% and 100%
    };

    // Group 1: Elite Candidates (5% of participants)
    const eliteCount = Math.floor(totalParticipants * 0.05);
    for (let i = 0; i < eliteCount; i++) {
        simulatedScores.push(generateNormalRandom(68, 8)); // High mean, low deviation
    }

    // Group 2: Prepared Candidates (45% of participants)
    const preparedCount = Math.floor(totalParticipants * 0.45);
    for (let i = 0; i < preparedCount; i++) {
        simulatedScores.push(generateNormalRandom(42, 12)); // Average mean, moderate deviation
    }

    // Group 3: Less Prepared/General Candidates (remaining 50%)
    const generalCount = totalParticipants - eliteCount - preparedCount;
    for (let i = 0; i < generalCount; i++) {
        simulatedScores.push(generateNormalRandom(25, 10)); // Low mean, moderate deviation
    }
    // --- End of Simulation Engine ---

    const allScores = [...simulatedScores, userOverallPercentage];
    allScores.sort((a, b) => b - a);
    
    const top1PercentCount = Math.ceil(allScores.length * 0.01);
    const top1PercentScores = allScores.slice(0, top1PercentCount);
    const top1PercentAverage = top1PercentScores.reduce((a, b) => a + b, 0) / top1PercentScores.length;
    const passThreshold = top1PercentAverage * 0.5;
    const isPassed = userOverallPercentage >= passThreshold;
    const averageScore = allScores.reduce((a, b) => a + b, 0) / allScores.length;
    const userRank = allScores.indexOf(userOverallPercentage) + 1;
    
    dom.reportUserName.textContent = `کارنامه شرکت‌کننده: ${currentUser}`;
    dom.finalScore.textContent = `${userOverallPercentage.toFixed(2)}%`;
    dom.userRank.textContent = `${userRank} از ${allScores.length}`;
    dom.averageScore.textContent = `${averageScore.toFixed(2)}%`;
    
    dom.reportTableBody.innerHTML = '';
    const orderedTopics = Object.keys(examStructure).flatMap(section => Object.keys(examStructure[section]));
    orderedTopics.forEach(topic => {
        if (report[topic]) {
            const r = report[topic];
            dom.reportTableBody.innerHTML += `<tr><td>${topic}</td><td>${r.correct}</td><td>${r.incorrect}</td><td>${r.unanswered}</td><td><b>${r.percentage.toFixed(2)}%</b></td></tr>`;
        }
    });
    
    let probabilityText = `حد نصاب قبولی (۵۰٪ میانگین ۱٪ برتر) در این شبیه‌سازی حدود <b>${passThreshold.toFixed(2)}%</b> است. نمره شما <b>${userOverallPercentage.toFixed(2)}%</b> می‌باشد.<br><br>`;
    if (isPassed) {
        probabilityText += `<span style="color: var(--success-color);"><b>تبریک! شما حد نصاب علمی لازم برای ورود به مرحله مصاحبه را کسب کرده‌اید.</b></span>`;
    } else {
        probabilityText += `<span style="color: var(--danger-color);"><b>متاسفانه شما حد نصاب علمی لازم را کسب نکرده‌اید.</b></span>`;
    }
    dom.finalProbability.innerHTML = probabilityText;
    
    dom.reportModal.classList.add('visible');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('visible');
}
</script>
</body>
</html>
